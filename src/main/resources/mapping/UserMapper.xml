<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hust.addrgeneration.dao.UserMapper">
    <insert id="register" parameterType="String">
        insert into register (nid, userID, phoneNumber, password, username)
        values (#{nid}, #{userID}, #{phoneNumber}, #{password}, #{username})
    </insert>

    <select id="queryRegisterInfo" parameterType="String" resultType="com.hust.addrgeneration.beans.User">
        select userID, phoneNumber, password, username from register where nid = #{nid}
    </select>

    <select id="queryPhoneNumber" parameterType="String" resultType="com.hust.addrgeneration.beans.User">
        select * from register where phoneNumber = #{phoneNumber}
    </select>

    <delete id="deleteUser" parameterType="String">
        delete from register where nid = #{nid}
    </delete>

    <select id="getAllRegisteredUsers" resultType="com.hust.addrgeneration.beans.User">
        select * from register
    </select>

    <insert id="updateAID" parameterType="String">
        insert into aid_info (aidnth, aid, prefix)
        values (#{aidnth}, #{aid}, #{prefix})
    </insert>

    <select id="queryAIDnTH" parameterType="String" resultType="String">
        select aidnth from aid_info where aid = #{aid}
    </select>

    <select id="queryPrefix" parameterType="String" resultType="String">
        select prefix from aid_info where aidnth = #{aidnth}
    </select>

    <insert id="updateAIDTrunc">
        insert into aid_trunc (address, visibleAID, hiddenAID, timeDifference, phoneNumber, registerTime, prefix)
        values (#{address}, #{visibleAID}, #{hiddenAID}, #{timeDifference}, #{phoneNumber}, #{registerTime}, #{prefix})
    </insert>

    <delete id="truncateAIDTrunc">
        truncate table aid_trunc
    </delete>

    <select id="queryAIDTruncHiddenAID" resultType="String">
        select hiddenAID from aid_trunc where visibleAID = #{visibleAID} and timeDifference = #{timeDifference}
    </select>

    <select id="queryAIDTruncTime" resultType="int">
        select timeDifference from aid_trunc where address = #{address}
    </select>

    <select id="queryAIDTruncAddress" parameterType="String" resultType="com.hust.addrgeneration.beans.Address">
        select address,registerTime from aid_trunc where phoneNumber = #{phoneNumber}
    </select>

    <select id="getIdeaKey" parameterType="String" resultType="String">
        select ideakey from key_info where addrGenIP = #{addrGenIP} and timehash = #{timeHash}
    </select>

    <insert id="updateKey" parameterType="String">
        insert into key_info (addrGenIP, ideakey, timehash)
        values (#{addrGenIP}, #{ideaKey}, #{timeHash})
    </insert>


    <select id="getUsersByFilter" resultType="com.hust.addrgeneration.beans.User">
        select register.* , aid_trunc.address, aid_trunc.registerTime, aid_trunc.prefix from register left join aid_trunc on register.nid = aid_trunc.nid
        where register.username LIKE CONCAT('%',#{content},'%') OR register.userID LIKE CONCAT('%',#{content},'%') LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="getUserCountByFilter" parameterType="String" resultType="int">
        select COUNT(*) from register left join aid_trunc on register.nid = aid_trunc.nid
        where register.username LIKE CONCAT('%',#{content},'%') OR register.userID LIKE CONCAT('%',#{content},'%')
    </select>
</mapper>